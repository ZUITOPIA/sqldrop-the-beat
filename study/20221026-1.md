> 20221026 기록 : 반정규화와 성능

### 반정규화를 통한 성능향상 전략

반정규화(역정규화, De-Normalization) ?

- 정규화된 엔터티, 속성, 관계에 대해 시스템의 성능향상과 개발/운영의 단순화를 위해 중복, 통합, 분리 등을 수행하는 기법 (오히려 데이터를 중복하여 데이터 조회 성능을 향상시키기 위함)
- 설계단계에서 수행함

데이터 무결성이 깨질 수 있음에도 불구하고 반정규화 하는 경우

- 데이터를 조회할 때 디스크 I/O 량이 많아서 성능 저하가 예상될 때
- 경로가 너무 멀어 조인으로 인한 성능 저하가 예상될 때
- 칼럼을 계산하여 읽는 과정에서 성능 저하가 예상될 때

반정규화를 기술적으로 수행하지 않는 경우

- 성능이 저하된 데이터베이스가 생성될 수 있음
- 구축단계나 시험단계에서 반정규화를 적용할 때 노력비용이 많이 들게 됨 (수정할게 많음)

### 반정규화의 적용 방법

반정규화를 적용할 때는 **데이터의 무결성을 보장**할 수 있는 방법을 고려한 후 적용하도록 해야함

|     반정규화 순서     |                                  방법                                   |
| :-------------------: | :---------------------------------------------------------------------: |
| 1. 반정규화 대상조사  | 범위처리빈도수, 대량의 범위처리, 통계성 프로세스, 테이블 조인 개수 조사 |
| 2. 다른 방법유도 검토 |       뷰 테이블, 클러스터링 적용, 인덱스의 조정, 응용애플리케이션       |
|   3. 반정규화 적용    |            테이블 반정규화, 속성의 반정규화, 관계의 반정규화            |

1. 반정규화 대상조사, 반정규화 고려해야 할 4가지 경우

   - 자주 사용되는 테이블에 접근하는 프로세스의 수가 많고 항상 일정한 범위만을 조회하는 경우
   - 테이블에 대량의 데이터가 있고 대량의 데이터 범위를 자주 처리할 때 처리범위를 일정하게 줄이지 않으면 성능을 보장할 수 없을 경우
   - 통계성 프로세스에 의해 통계 정보를 필요로 할 때 -> 별도의 통계테이블(반정규화 테이블) 생성
   - 테이블에 지나치게 많은 조인이 걸려 데이터 조회 작업이 기술적으로 어려울 경우

2. 다른 방법유도 검토, 가급적이면 데이터 무결성을 깨뜨릴 위험을 제어하기 위해 반정규화가 아닌 다른 방법으로 처리할 수 있는지 모색

   - 지나치게 많은 조인이 걸려 데이터 조회 작업이 기술적으로 어려운 경우 -> 뷰 사용
   - 대량의 데이터처리/부분처리에 의해 성능이 저하되는 경우 -> 클러스터링 적용하거나 인덱스를 조정  
     (클러스터링 : 데이터 입력, 수정, 삭제할 경우 성능이 많이 저하되므로 조회중심의 테이블일 때나 인덱스를 통한 성능향상이 불가능할 때 만 고려)

   - 대량의 데이터는 PK 성격에 따라 부분적인 테이블로 분리 (파티셔닝 기법, Partitioning)
   - 로직 구사 방법을 변경 (e.g. 데이터 처리하기 위한 값을 캐쉬, 중간 클래스 영역에 데이터를 캐쉬해 공유하게 함)  
     -> 다른 방법이 없다면 반정규화를 적용함

### **테이블** 반정규화

- [1] 테이블 병합

  - 1:1 관계를 통합하여 성능 향상
  - 1:M 관계를 통합하여 성능 향상
  - 슈퍼/서브 관계를 통합하여 성능 향상

- [2] 테이블 분할
  - 수직분할 : Column 단위 테이블을 1:1로 분리하여 성능 향상 (디스크 I/O를 분산처리하기 위해)
  - 수평분할 : Row 단위로 집중 발생되는 트랜잭션을 분석하여 Row 단위로 테이블을 쪼개 성능 향상(디스크 I/O 및 데이터 접근의 효율성을 높이기 위해)
    => 수평분할/수직분할 결정 4가지 원칙

1. 데이터 모델링을 완성
2. 데이터베이스 용량산정
3. 대량 데이터가 처리되는 테이블에 대해 트랜잭션 처리 패턴 분석
4. 집중화된 처리가 발생할 때, 칼럼 단위인지 로우 단위인지 분석하여 집중화된 단위로 테이블을 분리

- 칼럼이 많은 경우 1:1 분리, 데이터가 많은 경우 파티셔닝

- [3] 테이블 추가
  - 중복 : 다른 업무이거나 서버가 다른 경우, 동일한 테이블구조를 중복해 원격조인을 제거하여 성능 향상
  - 통계 : SUM, AVG 등을 미리 수행해 계산해둠으로써 조회 시 성능 향상
  - 이력 : 이력테이블 중 마스터테이블에 존재하는 레코드를 중복하여 이력테이블에 존재시켜 성능 향상
  - 부분 : 하나의 테이블의 전체 칼럼 중 자주 이용하는 집중화된 칼럼들이 있을 때 해당 칼럼들을 따로 모아놓은 별도의 반정규화된 테이블 생성 (디스크 I/O를 줄이기 위해)

### **칼럼** 반정규화

- 중복칼럼 추가 : 조인에 의해 처리할 때 성능 저하를 예방하기 위해 중복된 칼럼을 위치시킴
- 파생칼럼 추가 : 트랜잭션이 처리되는 시점에 계산에 의해 발생되는 성능저하를 예방하기 위해 미리 값을 계산하여 칼럼에 보관
- 이력테이블칼럼 추가 : 대량의 이력데이터를 처리할 때 불특정 날 조회나 최근 값을 조회할 때 나타날 수 있는 성능저하를 예방하기 위해 이력테이블에 기능성 칼럼(최근값 여부, 시작과 종료일자 등)을 추가함
- 응용시스템 오작동을 위한 칼럼 추가 : 사용자의 실수로 원래 값으로 복구하기 원하는 경우 이전 데이터를 임시적으로 중복하여 보관하는 기법
- PK에 의한 칼럼 추가 : 단일 PK 안에서 특정 값을 별도로 조회하는 경우 성능 저하가 발생할 수 있어 일반속성으로 추가함

### 로우 체이닝과 로우 마이그레이션

- 로우 체이닝 : 로우의 길이가 너무 길어서 데이터 블록 하나에 데이터가 모두 저장되지 않고 두 개 이상의 블록에 걸쳐 하나의 로우가 저장되어 있는 형태
- 로우 마이그레이션 : 데이터블록에서 수정이 발생하면 수정된 데이터를 해당 데이터 블록에서 저장하지 못 하고 다른 블록의 반공간을 찾아 저장하는 방식

> 로우 체이닝과 로우 마이그레이션이 발생하여 많은 블록에 데이터가 저장되면 DB 메모리에서 디스크 I/O가 발생할 때 많은 I/O가 발생하여 성능 저하 발생 -> 트랜잭션을 분석하여 적절한 1:1관계로 분리함으로써 성능 향상시킴

### PK에 의해 테이블을 분할하는 방법

- RANGE PARTITION : 대상 테이블이 날짜/숫자 값으로 분리 가능하고, 각 영역별로 트랜잭션 분리 가능한 경우 (e.g. 요금\_0401)
- LIST PARTITION : 지점, 사업소 등 핵심적인 코드값으로 PK가 구성돼 있고, 대량의 데이터가 있는 테이블의 경우 (e.g. 고객\_서울)
- HASH PARTITION : 지정된 HASH 조건에 따라 해시 알고리즘이 적용되어 테이블이 분리

### **관계** 반정규화 -> 무결성 유지

- 데이터를 처리하기 위한 여러 경로를 거쳐 조인이 가능하지만, 이 때 발생할 수 있는 성능저하를 예방하기 위해 추가적인 관계를 맺는 방법
